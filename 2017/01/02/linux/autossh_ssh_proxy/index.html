<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="www.lizs.cc"><meta name="keywords" content="lizs, www.lizs.cc, lizs.cc"><title>Linux - autossh + ssh proxy by socket5 - lizs</title><!-- link(rel="stylesheet", type="text/css", href="//fonts.neworld.org/css?family=Source+Code+Pro")--><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><!-- #header--><div id="layout" class="layout-g"><div class="layout-r"><div id="sidebar"><div class="site-name"><h1 class="title"><a href="/." class="home">lizs</a></h1><!-- h1.hidden= current_title--><!-- a#logo(href=url_for('.'))= config.title--><p class="description">www.lizs.cc</p></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="www.lizs.cc"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="time">{date}</div><div class="title">{title}</div><!-- .tags {tags}--></a></div></template></div></div><!-- .search-pla--><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh-设置-sockets-代理"><span class="toc-text">ssh 设置 sockets 代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-autossh-管理-ssh-进程"><span class="toc-text">使用 autossh 管理 ssh 进程</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 近期文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/01/python/abstract_base_classes/">Python - Abstract Base Classes</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/05/linux/centos6.6_deploy_php_mysql_nginx/">CentOS6.6 install PHP, MySQL and Nginx</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/05/linux/centos6.6_upgrade_python2.6/">CentOS6.6 upgrade Python2.6 to Python2.7</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/05/linux/cmd_netstat/">Linux command - netstat</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/03/python/http_server/">Python - HTTP Server</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/02/python/socket_server/">Python - Socket Server</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Cordova/">Cordova</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTTP/">HTTP</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/cmd/" style="font-size: 15px;">cmd</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/tutorial/" style="font-size: 15px;">tutorial</a> <a href="/tags/cordova/" style="font-size: 15px;">cordova</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/others/" style="font-size: 15px;">others</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/django/" style="font-size: 15px;">django</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li></ul></div><div id="nav-menu"></div></div></div><div class="layout-l"><div class="content_container"><div class="post"><div class="header"><h1 class="post-title">Linux - autossh + ssh proxy by socket5</h1><div class="post-meta"><p><span class="date">2017-01-02</span><span><a href="/categories/Linux/" class="category">Linux</a></span><span class="view_count"><i id="busuanzi_container_page_pv"><!-- i=  __('hits') + '数: '--><i id="busuanzi_value_page_pv"></i></i></span></p></div></div><div class="post-content"><h3 id="ssh-设置-sockets-代理"><a href="#ssh-设置-sockets-代理" class="headerlink" title="ssh 设置 sockets 代理"></a>ssh 设置 sockets 代理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -qTfnN -D 1080 root@alizs.cc</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-q</code>: Quiet modle. Causes most warning and diagnostic messages to be suppressed.</li>
<li><code>-T</code>: Disable pseudo-terminal allocation.</li>
<li><code>-f</code>: Requests ssh to go to background just before command execution. This is useful if ssh is going to ask for passwords or passphrases, but the user wants it in the background. This implies <code>-n</code>.</li>
<li><code>-n</code>: Redirects stdin from /dev/null (actually, prevents reading from stdin). This must be used when ssh is run in the background.</li>
<li><code>-N</code>: Do not execute a remote command. This is useful for just forwarding ports.</li>
<li><code>-D</code>: Specifies a local “dynamic” application-level port forwarding.</li>
<li><a href="mailto:`root@alizs.cc" target="_blank" rel="noopener">`root@alizs.cc</a>`: sockets 代理服务器</li>
</ul>
<blockquote>
<p>更多设置可以参考 <a href="https://man.openbsd.org/ssh" target="_blank" rel="noopener">ssh</a></p>
</blockquote>
<p>这样就可以将请求通过 sockets5 代理地址 <code>127.0.0.1:1080</code> 转发到代理服务器 <code>alizs.cc</code>，完成翻墙了。不过，这种方式实现的代理，会存在 <code>ssh</code> 经常断开链接的问题。这时候，可以用 <code>autossh</code> 来解决。</p>
<h3 id="使用-autossh-管理-ssh-进程"><a href="#使用-autossh-管理-ssh-进程" class="headerlink" title="使用 autossh 管理 ssh 进程"></a>使用 autossh 管理 ssh 进程</h3><blockquote>
<p>autossh 是一个用来启动并监控管理 ssh 的程序，在 ssh 断开的时候，autossh 会自动重启 ssh 进程。</p>
</blockquote>
<p>安装 autossh (ubuntu)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install autossh</span><br></pre></td></tr></table></figure></p>
<p>使用方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autossh [-V] [-M monitor_port[:echo_port]] [-f] [SSH_OPTIONS]</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>-M</code>: specifies monitor port. Overrides the environment variable AUTOSSH_PORT. 0 turns monitoring loop off. Alternatively, a port for an echo service on the remote machine may be specified.</li>
<li><code>-f</code>: run in background (autossh handles this, and does not pass it to ssh). 后台运行，并且 <code>-f</code> 参数不会传给 ssh，因为 ssh 也有 <code>-f</code> 参数。比如，执行 <code>autossh -M 0 -fqTnN -D 1080 root@alizs.cc</code> 的时候，autossh 进程会启动一个 ssh 进程，并且 <code>-qTnN -D 1080 root@alizs.cc</code> 这些参数是会传给 ssh 的，但是 <code>-f</code> 不会传给 ssh。也就是说 ssh 进程会像这样：<code>/usr/bin/ssh -qTnN -D 1080 root@alizs.cc</code>。</li>
<li><code>-V</code>: print autossh version and exit.</li>
</ul>
<p>使用实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autossh -M 0 -fqTN -D 1080 root@alizs.cc</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>-M</code>: <code>-M 0</code>，表示通过 端口检测 ssh 的连接状态，断开后就会自动重连。</li>
<li><code>-f</code>: 后台运行。</li>
<li><code>-qTN</code>: 是 ssh 的参数。(autossh 不传 <code>-f</code> 给 ssh，<code>-n</code> 也就没意义了。)</li>
</ul>
<p>运行以上命令之后，可以发现系统里多了两个进程，一个是 autossh，一个是 ssh。其中 ssh 是由 autossh 启动的，autossh 作为 ssh 的守护进程，监测 ssh 的状态，当 ssh 断开之后，会自动重启 ssh。</p>
</div><div class="tags"><a href="/tags/linux/">linux</a></div><div class="post-nav"><a href="/2017/01/02/python/virtualenv/" class="pre">Python - Virtualenv</a><a href="/2017/01/01/algorithm/basic/" class="next">Algorithm - Basic</a></div></div><!-- include _partial/footer--></div></div></div><a id="totop" href="#top"></a></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>