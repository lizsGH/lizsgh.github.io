<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="www.lizs.cc"><meta name="keywords" content="lizs, www.lizs.cc, lizs.cc"><title>Linux command - tcpdump - lizs</title><!-- link(rel="stylesheet", type="text/css", href="//fonts.neworld.org/css?family=Source+Code+Pro")--><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><!-- #header--><div id="layout" class="layout-g"><div class="layout-r"><div id="sidebar"><div class="site-name"><h1 class="title"><a href="/." class="home">lizs</a></h1><!-- h1.hidden= current_title--><!-- a#logo(href=url_for('.'))= config.title--><p class="description">www.lizs.cc</p></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="www.lizs.cc"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="time">{date}</div><div class="title">{title}</div><!-- .tags {tags}--></a></div></template></div></div><!-- .search-pla--><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#常用-options"><span class="toc-text">常用 options:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#expression"><span class="toc-text">expression</span></a></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 近期文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/06/linux/cmd_tcpdump/">Linux command - tcpdump</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/04/linux/cmd_netstat/">Linux command - netstat</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/02/docker/installation/">Docker - Install Docker (CE) for Ubuntu</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/24/python/object_oriented_programming/">Object Oriented Programming</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/24/python/abstract_base_classes/">Python - Abstract Base Classes</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/python/data_model/">Data model</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTTP/">HTTP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/cmd/" style="font-size: 15px;">cmd</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/tutorial/" style="font-size: 15px;">tutorial</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li></ul></div><div id="nav-menu"></div></div></div><div class="layout-l"><div class="content_container"><div class="post"><div class="header"><h1 class="post-title">Linux command - tcpdump</h1><div class="post-meta"><p><span class="date">2018-12-06</span><span><a href="/categories/Linux/" class="category">Linux</a></span><span class="view_count"><i id="busuanzi_container_page_pv"><!-- i=  __('hits') + '数: '--><i id="busuanzi_value_page_pv"></i></i></span></p></div></div><div class="post-content"><blockquote>
<p>Dump the traffic on a network.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump [options] [expression]</span><br></pre></td></tr></table></figure>
<h3 id="常用-options"><a href="#常用-options" class="headerlink" title="常用 options:"></a>常用 options:</h3><ul>
<li><code>-c count</code>: Exit after receiving <code>count</code> packets. 指定抓取的包的数量。</li>
<li><code>-D, --list-interfaces</code>: 打印出系统中可以被 tcpdump 抓包的网络接口。列出的网络接口包括相应的序号和网络接口名，可以用 <code>tcpdump -i</code>指定相应的网络接口或相应的序号来抓取特定网络接口的数据包。其中名为<code>any</code>的网络接口表示可以抓取所有网络接口的数据包 (<code>tcpdump -i any</code>)。</li>
<li><code>-F file</code>: 从指定的<code>file</code>中读取<code>expression</code>(<code>tcpdump [options] [expression]</code>)。</li>
<li><code>-i interface, --interface=interface</code>: 指定抓包的网络接口。如果没有指定<code>tcpdump</code>会监听<code>tcpdump -D</code>中第一个网络接口。当指定<code>interface</code>为<code>any</code>则表示监听所有网络接口。</li>
<li><code>-l</code>: Make stdout line buffered. 将抓包记录从标准输出变为行缓冲形式。当抓包的时候，你可以将抓包记录存到文件，边抓包边分析。</li>
<li><code>-n</code>: Don not convert address (i.e., host address, port numbers, etc) to names. 即直接显示数字形式的地址端口号等，而不进行解析。</li>
<li><code>-#, --number</code>: 给每行抓包的输出结果添加行号。</li>
<li><code>-q</code>: 简短快速输出。只打印较少的协议信息。</li>
<li><code>-t</code>: 每行抓包记录不打印时间。</li>
<li><code>-tt</code>: 将每行抓包记录的时间代替为时间戳形式。</li>
<li><code>-ttt</code>: 将每行记录的时间替换为和上一行的时间差。</li>
<li><code>-tttt</code>: 在每行记录的时间前添加日期 (默认只显示时分秒)。</li>
<li><code>-v</code>, <code>-vv</code>, <code>-vvv</code>: 打印其它详细信息，详细程度依次递增。</li>
<li><code>-w file</code>, 不打印抓取的数据包，而是将数据保存到<code>file</code>文件中，文件后缀一般为<code>.pcap</code>, <code>.cap</code>, <code>.dmp</code>。</li>
<li><code>-x</code>: 以十六进制形式打印数据包的头部信息。</li>
<li><code>-xx</code>: 比<code>-x</code>更加详细。</li>
<li><code>-X</code>: 以十六进制和 ASCII 的形式打印数据包的头部信息。</li>
<li><code>-XX</code>: 比<code>-X</code>更加详细。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统中可以被 tcpdump 抓包的网络接口</span></span><br><span class="line">sudo tcpdump -D</span><br><span class="line">    1.wlo1 [Up, Running]</span><br><span class="line">    2.vmnet1 [Up, Running]</span><br><span class="line">    3.vmnet8 [Up, Running]</span><br><span class="line">    4.any (Pseudo-device that captures on all interfaces) [Up, Running]</span><br><span class="line">    5.lo [Up, Running, Loopback]</span><br><span class="line">    6.docker0 [Up]</span><br><span class="line">    7.eno1 [Up]</span><br><span class="line">    8.br-eb58f5c99244 [Up]</span><br><span class="line">    9.bluetooth0 (Bluetooth adapter number 0)</span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># 监听所有接口</span></span><br><span class="line">sudo tcpdump -i any  <span class="comment"># 或 sudo tcpdump -i 4</span></span><br><span class="line"><span class="comment"># 将抓包信息保存到文件，可以边抓包边分析</span></span><br><span class="line">sudo tcpdump -nn -l &gt; packets.log &amp;</span><br><span class="line"><span class="comment"># 抓取 10 个数据包，并添加行号和显示数字形式的地址、端口信息</span></span><br><span class="line">sudo tcpdump -c 3 -n<span class="comment">#</span></span><br><span class="line">listening on wlo1, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">    1  19:55:08.990797 IP 192.168.3.3.53751 &gt; 192.168.0.102.63822: UDP, length 96</span><br><span class="line">    2  19:55:08.990972 IP 192.168.3.3.58581 &gt; 192.168.1.24.61048: UDP, length 96</span><br><span class="line">    3  19:55:08.991039 IP 192.168.3.3.41684 &gt; 140.240.42.194.4321: UDP, length 96</span><br><span class="line">3 packets captured</span><br><span class="line">4 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure>
<h2 id="expression"><a href="#expression" class="headerlink" title="expression"></a>expression</h2><p>expression 可以用来过滤抓取的数据包。</p>
<p>The filter expression consists of one or more primitives.  Primitives usually consist of an id (name or number) preceded by one or more qualifiers.  There are three different kinds of qualifier: type, dir, proto.<br>过滤表达式可以由 type, dir, proto 中的一个或多个组成。</p>
<ul>
<li><p><strong>type</strong>: type qualifiers say what kind of thing the id name or number refers to. Possible type are: <code>host</code>, <code>net</code>, <code>port</code> and <code>portrange</code>. E.g. <code>host lizs.cc</code>, <code>net 127.0</code>, <code>port 80</code>, <code>portrange 6000-6008</code>, etc.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监听地址以 127. 开头的数据包，如`127.0.0.1`, `127.0.1.1`等</span></span><br><span class="line">sudo tcpdump -c 3 -i any -n<span class="comment"># net 127</span></span><br><span class="line"><span class="comment"># 监听 lizs.cc</span></span><br><span class="line">sudo tcpdump -c 3 -i any -n<span class="comment"># host lizs.cc</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>dir</strong>: dir qualifiers specify a particular transfer direction to <code>and/or</code> from id. Possible directions are <code>src</code>, <code>dst</code>, <code>src or dst</code>, <code>src and dst</code>, <code>ra</code>, <code>ta</code>, <code>addr1</code>, <code>addr2</code>, <code>addr3</code>, and <code>addr4</code>.  E.g., <code>src  foo</code>, <code>dst net 128.3</code>, <code>src or dst port ftp-data</code>. The <code>ra</code>, <code>ta</code>, <code>addr1</code>, <code>addr2</code>, <code>addr3</code>, and <code>addr4</code> qualifiers are only valid for IEEE 802.11 Wireless LAN link layers.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监听源地址为 127.0.0.1 的数据包</span></span><br><span class="line">sudo tcpdump -c3 -i any -n<span class="comment"># src net 127.0.0.1</span></span><br><span class="line"><span class="comment"># 监听源地址或目的地址为 lizs.cc 的数据包</span></span><br><span class="line">sudo tcpdump -c3 -i any -n<span class="comment">#tttt src or dst host lizs.cc</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><strong>proto</strong>: proto qualifiers restrict the match to a  particular protocol. Possible protos are: <code>ether</code>, <code>fddi</code>, <code>tr</code>, <code>wlan</code>, <code>ip</code>, <code>ip6</code>, <code>arp</code>, <code>rarp</code>, <code>decnet</code>, <code>tcp</code> and <code>udp</code>. E.g., <code>ether src foo</code>, <code>arp net 128.3</code>, <code>tcp port 21</code>, <code>udp portrange 7000-7009</code>, <code>wlan addr2 0:2:3:4:5:6</code>.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监听 TCP 的数据包</span></span><br><span class="line">sudo tcpdump -c 3 -i any -n<span class="comment">#qtttt tcp</span></span><br><span class="line"><span class="comment"># 监听所有网络接口的 ICMP 数据包</span></span><br><span class="line">sudo tcpdump -c3 -i any -n<span class="comment">#qtttt icmp</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>除了以上 primitive，还有其它 primitive，如：<code>gateway</code>, <code>broadcast</code>, <code>less</code>, <code>greater</code>以及算术表达式，等等。</p>
<p>多个修饰语 (qualifier) 可以用<code>and</code>, <code>or</code>, <code>not</code>, <code>!</code>等连接组合起来，也可以用括号<code>()</code>指定优先级，不过要用反斜杠转义<code>\(\)</code>或 expression 用单引号或双引号括起来。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监听源端口为 80 或 443 的 TCP 数据包</span></span><br><span class="line">sudo tcpdump -n<span class="comment">#qtttt tcp src port 80 or 443  # 或者 sudo tcpdump -n#qtttt src port 80 or 443 and tcp</span></span><br><span class="line"><span class="comment"># 监听 lizs.cc 的 TCP 数据包，不过过滤掉和 github.com 通信的数据包</span></span><br><span class="line">sudo tcpdump -i any tcp host lizs.cc and not github.com</span><br><span class="line"><span class="comment"># 监听端口不为 1080 的非 TCP 数据包</span></span><br><span class="line">sudo tcpdump ! tcp port ! 1080</span><br><span class="line"><span class="comment"># 监听目的端口不为 1080 的 tcp 或 arp 包</span></span><br><span class="line">sudo tcpdump dst port ! 1080 and \(tcp or arp\)  <span class="comment"># 或</span></span><br><span class="line">sudo tcpdump <span class="string">'dst port ! 1080 and (tcp or arp)'</span>  <span class="comment"># 或</span></span><br><span class="line">sudo tcpdump tcp or arp dst port ! 1080</span><br><span class="line"><span class="comment"># 监听 ftp 端口或 telnet 端口的数据包</span></span><br><span class="line">sudo tcpdump -i any port ftp or telnet</span><br><span class="line"><span class="comment"># 监听所有通过网关 snup 的 ftp 数据包</span></span><br><span class="line">sudo tcpdump -i any <span class="string">'gateway snup and (port ftp or ftp-data)'</span></span><br><span class="line"><span class="comment"># 抓取数据包长度小于或等于 65 的 tcp 数据包。</span></span><br><span class="line">sudo tcpdump -i any tcp and less 65</span><br></pre></td></tr></table></figure></p>
<p>更多端口信息可以查看<code>/etc/services</code>。</p>
<p><strong>更多 expression 的详细语法可以通过 <code>man pcap-filter</code> 查看。</strong></p>
</div><div class="tags"><a href="/tags/linux/">linux</a><a href="/tags/cmd/">cmd</a></div><div class="post-nav"><a href="/2018/12/04/linux/cmd_netstat/" class="next">Linux command - netstat</a></div></div><!-- include _partial/footer--></div></div></div><a id="totop" href="#top"></a></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>